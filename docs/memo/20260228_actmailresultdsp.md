「ログイン後のマイページでも結果が見れる」という要件を加えると、システムはより「ストック型（資産として蓄積する形）」になります。

この場合、**「分析リクエスト」と「その結果」を管理する履歴テーブル**を中心に考えるのがスムーズです。

---

## 1. アップデート版：システムフロー

ログイン済みユーザーを想定するため、URLをクリックした際に「セッションがあるか」を確認するステップが加わります。

1. **リクエスト**: ユーザーがログイン後、分析ボタンを押す。
2. **受付**: DBに「処理中」ステータスでレコードを作成。ユーザーには「完了したらメールします」と表示。
3. **非同期処理**: バックエンドで分析を実行。
4. **完了処理**:
* DBのステータスを「完了」に更新し、結果データを書き込む。
* **通知フラグ**を立てる。


5. **マルチチャネル通知**:
* **メール**: 「分析が完了しました」というメッセージと、マイページ内の詳細URLを送信。
* **画面内通知**: ログイン後のトップページ等に「新着の分析結果があります」と表示。


6. **閲覧**: ユーザーはメールのリンク、またはマイページの履歴一覧から結果画面にアクセス。

---

## 2. データベース設計案

「誰が」「いつ」「どの分析を」行い、「結果がどうだったか」を管理します。

### 分析履歴テーブル (`analysis_reports`)

| カラム名 | 型 | 説明 |
| --- | --- | --- |
| `id` | UUID | URL等で使用する一意の識別子 |
| `user_id` | Integer | `users`テーブルとの紐付け（FK） |
| `title` | String | 分析名（例：「2024年10月度 傾向分析」） |
| `status` | Enum | `pending`, `processing`, `completed`, `failed` |
| `parameters` | JSONB | 分析時に指定した条件（再実行用） |
| `result_summary` | Text | 一覧画面に表示する短い要約 |
| `result_payload` | JSONB | 詳細画面で使うグラフ数値などのフルデータ |
| `is_read` | Boolean | ユーザーが結果を確認したか（既読フラグ） |
| `created_at` | Datetime | 実行開始日時 |

---

## 3. 実装のポイント：URLの設計

ログインを前提とする場合、URLの設計には2つのパターンがあります。

* **パターンA：ログイン必須URL**
* `https://example.com/my-page/reports/{uuid}`
* **メリット**: セキュリティが強固。万が一メールが誤送信されても、他人は閲覧できない。
* **デメリット**: ログインしていない場合、ログイン画面へ飛ばされるため、ユーザーに1手間かかる。


* **パターンB：ワンタイム（マジック）リンク**
* `https://example.com/reports/view?token=abc123xyz`
* **メリット**: クリックするだけで即座に結果が見れる。
* **デメリット**: トークン管理が複雑になる。



**おすすめは「パターンA」です。** ログイン状態を保持（Remember Me機能など）しておけば、ユーザー体験を損なわずに安全性を担保できます。

---

## 4. ユーザー画面（UI/UX）への展開案

マイページでは以下のような見せ方が可能です。

* **履歴一覧**: 過去の分析結果をリスト表示。ステータスが「処理中」のものはプログレスバーを出す。
* **ダッシュボード**: 最新の分析結果をカード形式で大きく表示。
* **未読バッジ**: ヘッダーのベルマーク等に、完了したけれどまだ見ていない件数を表示。

---

次は具体的に、**「分析結果のデータ量」**はどの程度を想定されていますか？（数行のテキスト程度か、あるいは複雑なグラフや画像が何枚も並ぶようなものか）

それによって、APIのレスポンス設計やストレージ構成をより詳細に検討できます。