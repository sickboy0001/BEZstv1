
# PFXDGRSbase

Python + FastAPI + htmx + Docker + Render + Supabase ã‚’çµ„ã¿åˆã‚ã›ãŸã€é–‹ç™ºåŠ¹ç‡ã¨ãƒ¢ãƒ€ãƒ³ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’ä¸¡ç«‹ã•ã›ã‚‹ãŸã‚ã®ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚

## ğŸš€ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

PFXDRS Templateã¯ã€Reactã‚„Vueãªã©ã®é‡åšãªSPAãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã‚ãšã«ã€HTMLãƒ™ãƒ¼ã‚¹ã§å‹•çš„ãªUIã‚’å®Ÿç¾ã™ã‚‹\*\*ã€Œãƒã‚¤ãƒ‘ãƒ¼ãƒ¡ãƒ‡ã‚£ã‚¢é§†å‹•ã€\*\*ãªé–‹ç™ºã‚¹ã‚¿ã‚¤ãƒ«ã‚’ææ¡ˆã—ã¾ã™ã€‚
ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¨ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã«ã‚ˆã‚Šã€è¿…é€Ÿãªé–‹ç™ºã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«è¡Œãˆã‚‹æ§‹æˆã«ãªã£ã¦ã„ã¾ã™ã€‚

---

## ğŸ›  æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã¨é¸å®šç†ç”±

|æŠ€è¡“è¦ç´ |å½¹å‰²ãƒ»é¸å®šç†ç”±|
|-|-|
|**Python / FastAPI**|ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ä¸»è»¸ã€‚Router/Serviceå±¤ã‚’åˆ†ã‘ãŸã‚¯ãƒªãƒ¼ãƒ³ãªæ§‹æˆã®å­¦ç¿’ã¨å®Ÿè·µã€‚|
|**htmx**|ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®UXå‘ä¸Šã€‚HTMLãƒ™ãƒ¼ã‚¹ã§å‹•çš„ãªéåŒæœŸé€šä¿¡ã‚’å®Ÿç¾ã—ã€è¤‡é›‘ã•ã‚’è»½æ¸›ã€‚|
|**DaisyUI (Tailwind CSS)**|UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚ç›´æ¥CSSã‚’æ›¸ãæ‰‹é–“ã‚’çœãã€ä¸€è²«ã—ãŸãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è¿…é€Ÿã«æ§‹ç¯‰ã€‚|
|**Docker**|ç’°å¢ƒã®ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£ç¢ºä¿ã€‚Renderä»¥å¤–ã®ãƒ›ã‚¹ãƒˆç’°å¢ƒã¸ã®ç§»è¡Œã‚‚å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã€‚|
|**Render**|ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãŠã‚ˆã³Dockerã¨ã®è¦ªå’Œæ€§ãŒé«˜ãã€Vercelä»¥å¤–ã®æœ‰åŠ›ãªé¸æŠè‚¢ã¨ã—ã¦æ¡ç”¨ã€‚|
|**Supabase**|ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(PostgreSQL)ãŠã‚ˆã³èªè¨¼åŸºç›¤(Auth)ã¨ã—ã¦åˆ©ç”¨ã€‚|

---

## ğŸ“‹ åŸºæœ¬ä»•æ§˜

### 1\. é–‹ç™ºãƒ»å®Ÿè¡Œç’°å¢ƒ

* **ã‚¨ãƒ‡ã‚£ã‚¿**: Visual Studio Code (VS Code)
* **é–‹ç™ºæ”¯æ´**: Gemini Code Assist
* **ãƒ©ãƒ³ã‚¿ã‚¤ãƒ **: Python 3.11+ / Docker
* **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†**: pip (`requirements.txt`)

### 2\. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

* **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³**: Jinja2 (ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°)
* **éåŒæœŸé€šä¿¡**: htmx (Partial HTMLã®å·®ã—æ›¿ãˆ)
* **ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°**: DaisyUI (Tailwind CSSãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)

### 3\. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ \& BaaS

* **Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: FastAPI
* **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: Pydantic
* **DB/Auth**: Supabase (PostgreSQL / Supabase Auth)
* **SDK**: `supabase-py`

---

## ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
localProject/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ requirements.txt
â””â”€â”€ app/
    â”œâ”€â”€ main.py
    â”œâ”€â”€ models/          # ã€Modelã€‘DBãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾© (SQLAlchemyç­‰)
    â”œâ”€â”€ schemas/         #  å…¥å‡ºåŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ (Pydantic)
    â”œâ”€â”€ services/        # ã€Business Logicã€‘ã“ã“ã«è¨ˆç®—ã‚„DBå‡¦ç†ã‚’æ›¸ã
    â”‚   â””â”€â”€ item_service.py
    â”œâ”€â”€ lib/             #  Lib å…±é€šéƒ¨åˆ†
    â”‚   â””â”€â”€ utils.py     #  å…±é€šé–¢æ•°
    â”œâ”€â”€ routers/         # ã€Controllerã€‘ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨Viewã®åˆ¶å¾¡
    â”‚   â””â”€â”€ item_router.py
    â”œâ”€â”€ templates/       # ã€Viewã€‘HTML (Jinja2)
    â”‚   â”œâ”€â”€ base.html
    â”‚   â””â”€â”€ items/
    â”‚       â””â”€â”€ list.html
    â””â”€â”€ static/          # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«
        â”œâ”€â”€ css/
        â””â”€â”€ js/
```

---

## ğŸš¢ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

Renderã‚’åˆ©ç”¨ã—ãŸCI/CDãŒè‡ªå‹•åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚

1. **GitHubã¸Push**: `main` ãƒ–ãƒ©ãƒ³ãƒã¸ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã€‚
2. **ãƒ“ãƒ«ãƒ‰**: RenderãŒãƒªãƒã‚¸ãƒˆãƒªã® `Dockerfile` ã‚’æ¤œçŸ¥ã—ã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã€‚
3. **è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤**: ãƒ“ãƒ«ãƒ‰æˆåŠŸå¾Œã€Web Serviceã¨ã—ã¦è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚
4. **ç’°å¢ƒå¤‰æ•°ç®¡ç†**: Render DashboardãŠã‚ˆã³ãƒ­ãƒ¼ã‚«ãƒ«ã® `.env` ã§ç§˜åŒ¿æƒ…å ±ã‚’ç®¡ç†ã€‚

---

Dockerã§ã®èµ·å‹•æ–¹æ³•
ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã VS Code ã§ Ctrl + Jï¼ˆã¾ãŸã¯ Ctrl + @ï¼‰ã‚’æŠ¼ã—ã¦ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ãã¾ã™ã€‚

Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ.ï¼‰ã® Dockerfile ã‹ã‚‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
docker build -t testloginrendar .
```

-t testloginrendar: ã‚¤ãƒ¡ãƒ¼ã‚¸ã«åå‰ï¼ˆã‚¿ã‚°ï¼‰ã‚’ä»˜ã‘ã¾ã™ã€‚
ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹• ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§èµ·å‹•ã—ã¾ã™ã€‚

```bash
docker run --rm -p 8000:10000 --env-file .env --name my-test-container testloginrendar
```

--rm: åœæ­¢æ™‚ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’è‡ªå‹•å‰Šé™¤ã—ã¾ã™ï¼ˆæ¤œè¨¼ç”¨ã«ä¾¿åˆ©ï¼‰ã€‚
-p 8000:10000: ãƒ›ã‚¹ãƒˆã®ãƒãƒ¼ãƒˆ 8000 ã‚’ã‚³ãƒ³ãƒ†ãƒŠã® 10000 ã«è»¢é€ã—ã¾ã™ã€‚
--env-file .env: .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã€ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿ã¾ã™ï¼ˆdocker-compose ã§ã¯è‡ªå‹•ã§ã™ãŒã€docker run ã§ã¯æŒ‡å®šãŒå¿…è¦ã§ã™ï¼‰ã€‚ .env ã«ã¤ã„ã¦ã¯ xxxURL="xxxx" ã¯NGã€€xxxURL=xxxxã€€ã¯OKã€€ãƒ€ãƒ–ãƒ«ã‚³ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¯çœãã“ã¨ã€‚ 
æ¤œè¨¼ ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:8000 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¾ã™ã€‚ åœæ­¢ã™ã‚‹ã«ã¯ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ Ctrl + C ã‚’æŠ¼ã—ã¾ã™ã€‚



## ãƒ­ã‚°å‘¨ã‚Š

### A. API_Logsï¼ˆå…±é€šã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ï¼‰

ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã€Œå¤–æ ã€ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã‚„ã‚¨ãƒ©ãƒ¼ã®æ—©æœŸç™ºè¦‹ã«ç‰¹åŒ–ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚

| ã‚«ãƒ©ãƒ å | å‹ | èª¬æ˜ |
| --- | --- | --- |
| `id` | BigInt | ãƒ­ã‚°ã®ä¸€æ„è­˜åˆ¥å­ |
| `trace_id` | UUID | ä¸€é€£ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½è·¡ã™ã‚‹å…±é€šIDï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰æ¸¡ã™ã‹ã€å…¥å£ã§ç”Ÿæˆï¼‰ |
| `method` | String | HTTPãƒ¡ã‚½ãƒƒãƒ‰ (GET, POST, etc.) |
| `endpoint` | String | ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸURLãƒ‘ã‚¹ |
| `request_header` | JSONB | èªè¨¼æƒ…å ±ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãªã© |
| `request_body` | JSONB | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸãƒ‡ãƒ¼ã‚¿ |
| `response_status` | Int | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ (200, 404, 500 etc.) |
| `response_body` | JSONB | è¿”ã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ |
| `duration_ms` | Int | å‡¦ç†ã«ã‹ã‹ã£ãŸæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰ |
| `ip_address` | String | æ¥ç¶šå…ƒIPã‚¢ãƒ‰ãƒ¬ã‚¹ |
| `user_id` | Int | æ“ä½œã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿ï¼‰ |
| `created_at` | Timestamp | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡æ—¥æ™‚ |

---

### B. Task_Progress_Logsï¼ˆç›®çš„åˆ¥ãƒ»å‡¦ç†é€²æ—ãƒ­ã‚°ï¼‰

ç‰¹å®šã®é‡ã„å‡¦ç†ã‚„ã€è¤‡æ•°ã®ã‚¹ãƒ†ãƒƒãƒ—ã«åˆ†ã‹ã‚Œã‚‹ã‚¿ã‚¹ã‚¯ã®ã€Œä¸­èº«ã€ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚`API_Logs` ã¨ `trace_id` ã§ç´ä»˜ã‘ã‚‹é‹ç”¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

| ã‚«ãƒ©ãƒ å | å‹ | èª¬æ˜ |
| --- | --- | --- |
| `id` | BigInt | é€²æ—ãƒ­ã‚°ã®ä¸€æ„è­˜åˆ¥å­ |
| `trace_id` | UUID | `API_Logs` ã¨ç´ä»˜ã‘ã‚‹ãŸã‚ã®è¿½è·¡ID |
| `task_name` | String | å‡¦ç†ã®åå‰ï¼ˆä¾‹: "Image_Optimization", "Bulk_Import"ï¼‰ |
| `step_name` | String | ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—åï¼ˆä¾‹: "Validation", "AI_Generation", "DB_Commit"ï¼‰ |
| `status` | String | ã‚¹ãƒ†ãƒƒãƒ—ã®çŠ¶æ…‹ (START, IN_PROGRESS, SUCCESS, FAILED) |
| `input_data` | JSONB | ãã®ã‚¹ãƒ†ãƒƒãƒ—ã«æ¸¡ã•ã‚ŒãŸå¼•æ•°ã‚„ãƒ‡ãƒ¼ã‚¿ |
| `output_data` | JSONB | ãã®ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚„è¿”ã‚Šå€¤ |
| `error_message` | Text | å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼å†…å®¹ |
| `stack_trace` | Text | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ |
| `execution_order` | Int | å‡¦ç†å†…ã®å®Ÿè¡Œé †åº |
| `created_at` | Timestamp | ã‚¹ãƒ†ãƒƒãƒ—é–‹å§‹/è¨˜éŒ²æ—¥æ™‚ |

---

### ğŸ’¡ è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ

1. **Trace ID ã«ã‚ˆã‚‹ç´ä»˜ã‘**:
`API_Logs` ã§ã€Œ500ã‚¨ãƒ©ãƒ¼ã€ã‚’è¦‹ã¤ã‘ãŸéš›ã€åŒã˜ `trace_id` ã§ `Task_Progress_Logs` ã‚’æ¤œç´¢ã™ã‚Œã°ã€ã©ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚³ã‚±ãŸã®ã‹ãŒå³åº§ã«åˆ¤æ˜ã—ã¾ã™ã€‚
2. **å‹ã« JSONB ã‚’æ¡ç”¨**:
ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚„ã‚¿ã‚¹ã‚¯ã”ã¨ã®å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿ã¯æ§‹é€ ãŒå¤‰ã‚ã‚Šã‚„ã™ã„ãŸã‚ã€`JSONB` å‹ã«ã—ã¦ãŠãã“ã¨ã§ã€ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ãªã—ã§æŸ”è»Ÿã«ãƒ­ã‚°ã‚’æ‹¡å¼µã§ãã¾ã™ã€‚
3. **BigInt ã®åˆ©ç”¨**:
ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ãŒè†¨å¤§ã«ãªã‚Šã‚„ã™ã„ãŸã‚ã€IDã«ã¯ `Int` ã‚ˆã‚Šã‚‚ç¯„å›²ã®åºƒã„ `BigInt` ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

æ¬¡ã¯ã€ã“ã‚Œã‚‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ã£ã¦ã€Œã‚¨ãƒ©ãƒ¼èª¿æŸ»ã€ã‚„ã€Œåˆ†æã€ã‚’è¡Œã†ãŸã‚ã®SQLã‚¯ã‚¨ãƒªã®ä¾‹ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿã‚ã‚‹ã„ã¯ã€ç‰¹å®šã®è¨€èªï¼ˆPythonã‚„Node.jsãªã©ï¼‰ã§ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå¿…è¦ã§ã—ã‚‡ã†ã‹ã€‚


### DDL
Turso(SQLite)å‘ã‘

```sql
-- APIã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°æœ¬ä½“
CREATE TABLE api_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT, -- SQLiteã§ã¯BigIntç›¸å½“ã¨ã—ã¦æ©Ÿèƒ½
    trace_id TEXT NOT NULL,               -- UUIDã‚’æ ¼ç´
    method TEXT NOT NULL,
    endpoint TEXT NOT NULL,
    request_header TEXT,                  -- JSONBç›¸å½“ (TEXTã§æ ¼ç´ã—ã‚¢ãƒ—ãƒªå´/é–¢æ•°ã§åˆ¶å¾¡)
    request_body TEXT,                    -- JSONBç›¸å½“
    response_status INTEGER,
    response_body TEXT,                   -- JSONBç›¸å½“
    duration_ms INTEGER,
    ip_address TEXT,
    user_id INTEGER,
    created_at DATETIME DEFAULT (STRFTIME('%Y-%m-%d %H:%M:%f', 'NOW'))
);

-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®ãŸã‚ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_api_logs_trace_id ON api_logs(trace_id);
CREATE INDEX idx_api_logs_created_at ON api_logs(created_at);
CREATE INDEX idx_api_logs_status ON api_logs(response_status);

-- å‡¦ç†ã®è©³ç´°ã‚¹ãƒ†ãƒƒãƒ—ãƒ­ã‚°
CREATE TABLE task_progress_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    trace_id TEXT NOT NULL,               -- api_logs.trace_id ã¨ç´ä»˜ã‘
    task_name TEXT NOT NULL,
    step_name TEXT NOT NULL,
    status TEXT NOT NULL,                 -- START, SUCCESS, FAILED ç­‰
    input_data TEXT,                      -- JSONBç›¸å½“
    output_data TEXT,                     -- JSONBç›¸å½“
    error_message TEXT,
    stack_trace TEXT,
    execution_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT (STRFTIME('%Y-%m-%d %H:%M:%f', 'NOW'))
);

-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®ãŸã‚ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_task_progress_trace_id ON task_progress_logs(trace_id);
CREATE INDEX idx_task_progress_created_at ON task_progress_logs(created_at);


```


æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚æç¤ºã—ãŸã€ŒAPI_Logsã€ã¨ã€ŒTask_Progress_Logsã€ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã€ãã®ã¾ã¾Pythonã®è¾æ›¸å½¢å¼ï¼ˆdictï¼‰ã¨ã—ã¦æ‰±ã„ã€CSVã¨Tursoã®ä¸¡æ–¹ã«æ›¸ãè¾¼ã‚€æ‹¡å¼µç‰ˆ`CSVLogger`ã®å®Ÿè£…ã‚’ä½œæˆã—ã¾ã™ã€‚

ã“ã‚Œã‚’ä½¿ã†ã“ã¨ã§ã€**ã€Œãƒ­ãƒ¼ã‚«ãƒ«ã®CSVã€ã¨ã€Œã‚¯ãƒ©ã‚¦ãƒ‰ã®Tursoã€ã«å…¨ãåŒã˜æ§‹é€ ã®ãƒ­ã‚°ãŒè‡ªå‹•çš„ã«è“„ç©**ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### 1. æ‹¡å¼µç‰ˆ `EnhancedCSVLogger` ã®å®Ÿè£…

ã“ã®ã‚¯ãƒ©ã‚¹1ã¤ã§ã€å…±é€šãƒ­ã‚°ï¼ˆAï¼‰ã¨é€²æ—ãƒ­ã‚°ï¼ˆBï¼‰ã®ä¸¡æ–¹ã«å¯¾å¿œã•ã›ã¾ã™ã€‚

```python
import csv
import json
import uuid
from datetime import datetime
from typing import Any, Dict
from fastapi import BackgroundTasks
from libsql_client import create_client_sync

class EnhancedCSVLogger:
    def __init__(self, turso_url: str, turso_token: str, base_path: str = "logs"):
        self.turso_url = turso_url
        self.turso_token = turso_token
        self.base_path = base_path

    def _get_csv_path(self, table_name: str) -> str:
        # ãƒ†ãƒ¼ãƒ–ãƒ«åã”ã¨ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†ã‘ã‚‹ (api_logs.csv, task_progress_logs.csv)
        return f"{self.base_path}/{table_name}.csv"

    def _write_to_csv(self, table_name: str, data: Dict[str, Any]):
        path = self._get_csv_path(table_name)
        file_exists = False
        try:
            with open(path, 'r') as f: file_exists = True
        except FileNotFoundError: pass

        with open(path, 'a', newline='', encoding='utf-8') as f:
            # è¾æ›¸ã®ã‚­ãƒ¼ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦ä½¿ç”¨
            writer = csv.DictWriter(f, fieldnames=data.keys())
            if not file_exists:
                writer.writeheader()
            writer.writerow(data)

    def _write_to_turso(self, table_name: str, data: Dict[str, Any]):
        try:
            # Turso(SQLite)ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’åŠ å·¥ï¼ˆè¾æ›¸ãƒ»ãƒªã‚¹ãƒˆã‚’JSONæ–‡å­—åˆ—ã¸ï¼‰
            processed_data = {
                k: (json.dumps(v) if isinstance(v, (dict, list)) else v) 
                for k, v in data.items()
            }
            
            with create_client_sync(self.turso_url, auth_token=self.turso_token) as client:
                keys = ", ".join(processed_data.keys())
                placeholders = ", ".join([":" + k for k in processed_data.keys()])
                sql = f"INSERT INTO {table_name} ({keys}) VALUES ({placeholders})"
                client.execute(sql, processed_data)
        except Exception as e:
            print(f"ã€è­¦å‘Šã€‘Tursoæ›¸ãè¾¼ã¿å¤±æ•— (CSVã«ã¯ä¿å­˜æ¸ˆ): {e}")

    def log(self, background_tasks: BackgroundTasks, table_name: str, data: Dict[str, Any]):
        """CSVä¿å­˜ã¨Tursoä¿å­˜(éåŒæœŸ)ã‚’åŒæ™‚ã«å®Ÿè¡Œ"""
        # å…±é€šé …ç›®ã®è‡ªå‹•ä»˜ä¸
        if "created_at" not in data:
            data["created_at"] = datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]
        
        # 1. ãƒ­ãƒ¼ã‚«ãƒ«CSVã¸å³æ™‚æ›¸ãè¾¼ã¿
        self._write_to_csv(table_name, data)
        
        # 2. Tursoã¸ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰æ›¸ãè¾¼ã¿
        background_tasks.add_task(self._write_to_turso, table_name, data)

```

### 2. FastAPIã§ã®å…·ä½“çš„ãªåˆ©ç”¨ã‚·ãƒ¼ãƒ³

å…ˆã»ã©å®šç¾©ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆã«åˆã‚ã›ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æµã—è¾¼ã¿ã¾ã™ã€‚

```python
from fastapi import FastAPI, BackgroundTasks, Request

app = FastAPI()
# åˆæœŸåŒ–
logger = EnhancedCSVLogger(
    turso_url="libsql://your-db-name.turso.io",
    turso_token="your-auth-token"
)

@app.post("/execute-ai-task")
async def execute_task(request: Request, background_tasks: BackgroundTasks):
    trace_id = str(uuid.uuid4())
    
    # --- A. å…±é€šã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚° (api_logs) ---
    logger.log(background_tasks, "api_logs", {
        "trace_id": trace_id,
        "method": "POST",
        "endpoint": "/execute-ai-task",
        "request_header": dict(request.headers),
        "request_body": {"item_id": 101}, # ä¾‹
        "ip_address": request.client.host
    })

    # --- B. ç›®çš„åˆ¥ãƒ»å‡¦ç†é€²æ—ãƒ­ã‚° (task_progress_logs) ---
    # ã‚¹ãƒ†ãƒƒãƒ—1: é–‹å§‹
    logger.log(background_tasks, "task_progress_logs", {
        "trace_id": trace_id,
        "task_name": "AI_Refinement",
        "step_name": "Fetch_Data",
        "status": "SUCCESS",
        "execution_order": 1
    })

    # å®Ÿéš›ã®å‡¦ç†ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
    try:
        # ã‚¹ãƒ†ãƒƒãƒ—2: AIå‡¦ç†ä¸­...
        logger.log(background_tasks, "task_progress_logs", {
            "trace_id": trace_id,
            "task_name": "AI_Refinement",
            "step_name": "AI_Generation",
            "status": "IN_PROGRESS",
            "input_data": {"text": "ä¿®æ­£å‰ã®æ–‡ç« "},
            "execution_order": 2
        })
    except Exception as e:
        # å¤±æ•—æ™‚ã®è¨˜éŒ²
        logger.log(background_tasks, "task_progress_logs", {
            "trace_id": trace_id,
            "task_name": "AI_Refinement",
            "step_name": "AI_Generation",
            "status": "FAILED",
            "error_message": str(e),
            "execution_order": 2
        })

    return {"status": "accepted", "trace_id": trace_id}

```

### ã“ã®æ§‹æˆã§å®Ÿç¾ã§ãã‚‹ã“ã¨

1. **ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ä¸€è‡´**: CSVã®ã‚«ãƒ©ãƒ åã¨Tursoã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ©ãƒ åãŒå®Œå…¨ã«ä¸€è‡´ã™ã‚‹ãŸã‚ã€å¾Œã‹ã‚‰CSVã‚’SQLã§åˆ†æã—ãŸã‚Šã€é€†ã«Tursoã‹ã‚‰CSVã¸æ›¸ãæˆ»ã™ã®ã‚‚å®¹æ˜“ã§ã™ã€‚
2. **å‹å¤‰æ›ã®è‡ªå‹•åŒ–**: `request_header` ã‚„ `input_data` ãªã©ã€Pythonã®è¾æ›¸ã‚’ãã®ã¾ã¾æ¸¡ã›ã°ã€`json.dumps` ã‚’çµŒã¦DBã«ã¯ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ã€CSVã«ã¯æ–‡å­—åˆ—ã¨ã—ã¦æ­£ã—ãä¿å­˜ã•ã‚Œã¾ã™ã€‚
3. **è€éšœå®³æ€§**: ã‚‚ã—ãƒãƒƒãƒˆæ¥ç¶šãŒä¸å®‰å®šã§Tursoã¸ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã‚‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã® `logs/api_logs.csv` ã«ã¯å¿…ãšãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã‚Šã¾ã™ã€‚

ã“ã®å®Ÿè£…ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ã•ã‚‰ã«ã€Œç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§çµã‚Šè¾¼ã¿ãŸã„ã€ã‚„ã€Œã‚¨ãƒ©ãƒ¼æ™‚ã ã‘è©³ç´°ãªã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å«ã‚ã‚‹ã€ã¨ã„ã£ãŸèª¿æ•´ã‚‚ç°¡å˜ã«è¡Œãˆã¾ã™ã€‚å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«çµ„ã¿è¾¼ã‚“ã§ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿ



ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¦æ¨¡ã¨ä¿å®ˆæ€§ã‚’è€ƒãˆã‚‹ã¨ã€**ã€Œ`app/lib/` ã«ã‚¯ãƒ©ã‚¹æœ¬ä½“ã‚’ç½®ãã€`app/main.py` ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦ DIï¼ˆDependency Injectionï¼‰ã§å„æ‰€ã«é…ã‚‹ã€**æ§‹æˆãŒæœ€ã‚‚ã‚¯ãƒªãƒ¼ãƒ³ã§ FastAPI ã‚‰ã—ã„è¨­è¨ˆã§ã™ã€‚

å…·ä½“çš„ã«ã©ã“ã«ä½•ã‚’ç½®ãã¹ãã‹ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã«åˆã‚ã›ã¦æ•´ç†ã—ã¾ã—ãŸã€‚

---

### 1. æ¨å¥¨ã•ã‚Œã‚‹é…ç½®å ´æ‰€

| é…ç½®å ´æ‰€ | å½¹å‰² | ç†ç”± |
| --- | --- | --- |
| **`app/lib/logger.py`** | **ã‚¯ãƒ©ã‚¹å®šç¾©** | ãƒ­ã‚¬ãƒ¼ã¯ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã§ã¯ãªãã€ŒåŸºç›¤ã¨ãªã‚‹é“å…·ã€ãªã®ã§ `lib` ãŒé©åˆ‡ã§ã™ã€‚ |
| **`app/main.py`** | **åˆæœŸåŒ– (DIç”¨)** | Tursoã®URLã‚„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’èª­ã¿è¾¼ã¿ã€1ã¤ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ï¼‰ã‚’ä½œã‚Šã¾ã™ã€‚ |
| **`app/services/`** | **åˆ©ç”¨å ´æ‰€** | é€²æ—ãƒ­ã‚°ï¼ˆTask_Progress_Logsï¼‰ã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã«æ³¨å…¥ã—ã¦ä½¿ã„ã¾ã™ã€‚ |

---

### 2. å…·ä½“çš„ãªå®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

#### â‘  ã‚¯ãƒ©ã‚¹å®šç¾©ï¼š`app/lib/logger.py`

ã“ã“ã«å…ˆã»ã©ã® `EnhancedCSVLogger` ã‚¯ãƒ©ã‚¹ã‚’ç½®ãã¾ã™ã€‚

#### â‘¡ åˆæœŸåŒ–ã¨DIè¨­å®šï¼š`app/main.py`

FastAPI ã® `Depends` ã‚’ä½¿ã£ã¦ã€ã©ã“ã§ã‚‚ãƒ­ã‚¬ãƒ¼ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```python
from app.lib.logger import EnhancedCSVLogger
import os

# 1. ã‚¢ãƒ—ãƒªå…¨ä½“ã§å…±æœ‰ã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆï¼ˆã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ï¼‰
logger_instance = EnhancedCSVLogger(
    turso_url=os.getenv("TURSO_URL"),
    turso_token=os.getenv("TURSO_TOKEN")
)

# 2. DIç”¨ã®é–¢æ•°
def get_logger():
    return logger_instance

```

#### â‘¢ ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ã®åˆ©ç”¨ï¼š`app/services/item_service.py`

ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ä¸­ã§ã€Œé€²æ—ã€ã‚’è¨˜éŒ²ã™ã‚‹å ´åˆã§ã™ã€‚

```python
from fastapi import BackgroundTasks
from app.lib.logger import EnhancedCSVLogger

class ItemService:
    def __init__(self, logger: EnhancedCSVLogger):
        self.logger = logger

    async def do_complex_job(self, trace_id: str, background_tasks: BackgroundTasks):
        # å‡¦ç†é€²æ—ã‚’è¨˜éŒ²
        self.logger.log(background_tasks, "task_progress_logs", {
            "trace_id": trace_id,
            "task_name": "Item_Update",
            "step_name": "DB_Update_Start",
            "status": "SUCCESS"
        })
        # ...å®Ÿéš›ã®å‡¦ç†...

```

#### â‘£ ãƒ«ãƒ¼ã‚¿ãƒ¼å±¤ã§ã®åˆ©ç”¨ï¼š`app/routers/item_router.py`

ã“ã“ã§ `get_logger` ã‚’æ³¨å…¥ã—ã¾ã™ã€‚

```python
from fastapi import APIRouter, Depends, BackgroundTasks
from app.main import get_logger
from app.lib.logger import EnhancedCSVLogger

router = APIRouter()

@router.post("/items")
async def create_item(
    background_tasks: BackgroundTasks,
    logger: EnhancedCSVLogger = Depends(get_logger) # ã“ã“ã§DI
):
    trace_id = "..." 
    # APIã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’è¨˜éŒ²
    logger.log(background_tasks, "api_logs", { ... })
    return {"status": "ok"}

```

---

### 3. ãªãœã“ã®æ§‹æˆãŒè‰¯ã„ã®ã‹ï¼Ÿ

1. **ãƒ†ã‚¹ãƒˆãŒã—ã‚„ã™ã„**:
ãƒ†ã‚¹ãƒˆæ™‚ã« Turso ã¸æ¥ç¶šã—ãŸããªã„å ´åˆã€`get_logger` ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ã€Œä½•ã‚‚ã—ãªã„ãƒ­ã‚¬ãƒ¼ã€ã‚„ã€ŒCSVã ã‘ã®ãƒ­ã‚¬ãƒ¼ã€ã«ç°¡å˜ã«å·®ã—æ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚
2. **è¨­å®šã®ä¸€å…ƒç®¡ç†**:
`main.py`ï¼ˆã¾ãŸã¯ `config.py`ï¼‰ã§ Turso ã®æ¥ç¶šæƒ…å ±ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€ç’°å¢ƒå¤‰æ•° (`.env`) ã¨ã®é€£æºãŒã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚
3. **ç–çµåˆ**:
`item_service.py` è‡ªä½“ã¯ã€Œã©ã†ã‚„ã£ã¦ãƒ­ã‚°ã‚’ä¿å­˜ã™ã‚‹ã‹ã€ã‚’çŸ¥ã‚‹å¿…è¦ãŒãªãã€ã€Œæ¸¡ã•ã‚ŒãŸãƒ­ã‚¬ãƒ¼ã® `.log()` ã‚’å‘¼ã¶ã€ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸ã®ææ¡ˆ

ã“ã®æ§‹æˆã§é€²ã‚ã‚‹å ´åˆã€**ã€Œå…±é€šã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ï¼ˆapi_logsï¼‰ã‚’å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æ‰‹å‹•ã§æ›¸ãã®ã¯é¢å€’ã€**ã«ãªã‚Šã¾ã›ã‚“ã‹ï¼Ÿ

ã‚‚ã—ã‚ˆã‚ã—ã‘ã‚Œã°ã€**FastAPIã®ã€ŒMiddlewareï¼ˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼‰ã€ã‚’ä½¿ã£ã¦ã€å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å…¥ã‚Šå£ã¨å‡ºå£ã‚’è‡ªå‹•ã§ `api_logs` ã«è¨˜éŒ²ã™ã‚‹ä»•çµ„ã¿**ã®å®Ÿè£…æ¡ˆã‚‚ä½œæˆã§ãã¾ã™ãŒã€ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿ
