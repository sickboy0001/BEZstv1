{% extends "base.html" %} {% block title %}Dashboard - API Test{% endblock %} {%
block content %}
<div class="container mt-4">
  <div class="d-flex align-items-center mb-4 border-bottom pb-3">
    <h2 class="mb-0">Cleaning_post_api_test2</h2>
  </div>

  <div class="row">
    <div class="col-lg-12">
      {% if error %}
      <div class="alert alert-danger mb-4">{{ error }}</div>
      {% endif %}

      <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white p-3">
          <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>実行パラメータ</h5>
        </div>
        <div class="card-body bg-light-subtle">
          <form
            onsubmit="
              event.preventDefault();
              callApi();
            "
          >
            <div class="mb-4">
              <label class="form-label fw-bold"
                >User ID <span class="badge bg-danger ms-1">必須</span></label
              >
              <input
                type="text"
                id="userId"
                class="form-control"
                placeholder="UUIDを入力"
                value="{{ user_id }}"
                required
              />
            </div>

            <div class="card border-primary-subtle mb-4">
              <div class="card-body bg-white py-2">
                <!-- Row 1: B-1 期間指定 -->
                <div class="row g-2 align-items-center mb-2">
                  <div class="col-auto" style="min-width: 120px">
                    <span class="fw-bold text-secondary small"
                      ><i class="bi bi-calendar-range me-1"></i>B-1: 期間
                      (date_start, date_end)</span
                    >
                  </div>
                  <div class="col">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text">開始</span>
                      <input
                        type="date"
                        id="startDate"
                        class="form-control"
                        value="{{ target_period.start_date }}"
                      />
                      <span class="input-group-text">終了</span>
                      <input
                        type="date"
                        id="endDate"
                        class="form-control"
                        value="{{ target_period.end_date }}"
                      />
                    </div>
                  </div>
                </div>

                <!-- Row 2: B-2 ID指定 -->
                <div class="row g-2 align-items-center mb-2">
                  <div class="col-auto" style="min-width: 120px">
                    <span class="fw-bold text-secondary small"
                      ><i class="bi bi-list-check me-1"></i>B-2: ID
                      (target_post_ids)</span
                    >
                  </div>
                  <div class="col">
                    <div class="input-group input-group-sm">
                      <input
                        type="text"
                        id="postIds"
                        class="form-control"
                        placeholder="例: 101, 102 (カンマ区切り)"
                      />
                      <button
                        class="btn btn-outline-secondary"
                        type="button"
                        hx-get="/api/ui/post-selector"
                        hx-target="#modal-container"
                        hx-swap="innerHTML"
                      >
                        <i class="bi bi-search"></i> 選択
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Row 3: B-3 再問い合わせ -->
                <div class="row g-2 align-items-center">
                  <div class="col-auto" style="min-width: 120px">
                    <span class="fw-bold text-secondary small"
                      >B-3: 再処理 (is_force_reprocess)</span
                    >
                  </div>
                  <div class="col">
                    <select
                      id="is_force_reprocess"
                      class="form-select form-select-sm"
                    >
                      <option value="false" selected>未処理分のみ</option>
                      <option value="true">処理済みも対象</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Row: C (実行モード) & E, F (DB設定) -->
            <div class="row g-3 mb-3 align-items-end">
              <div class="col-md-5">
                <label class="form-label small fw-bold text-info"
                  >C: 実行モード (is_dry_run_only)</label
                >
                <div class="d-flex gap-3 mt-1">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="is_dry_run_only"
                      id="mode_result"
                      value="mode_result"
                      checked
                      onchange="handleDryRunMode(this.value)"
                    />
                    <label class="form-check-label" for="mode_result"
                      >結果登録</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="is_dry_run_only"
                      id="mode_ai"
                      value="mode_ai"
                      checked
                      onchange="handleDryRunMode(this.value)"
                    />
                    <label class="form-check-label" for="mode_ai">AI実行</label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="is_dry_run_only"
                      id="mode_script"
                      value="mode_script"
                      onchange="handleDryRunMode(this.value)"
                    />
                    <label class="form-check-label" for="mode_script"
                      >スクリプト作成のみ</label
                    >
                  </div>
                </div>
              </div>

              <div class="col-md-7">
                <label class="form-label small fw-bold text-muted"
                  >DB登録設定 (モード連動)</label
                >
                <div class="card bg-light-subtle border-0">
                  <div class="card-body py-2 d-flex align-items-center gap-3">
                    <div class="form-check form-switch mb-0">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="is_enable_batch_log"
                        checked
                        onchange="syncPostRefinementFlag()"
                      />
                      <label
                        class="form-check-label small"
                        for="is_enable_batch_log"
                        >E: バッチログ (is_enable_batch_log)</label
                      >
                    </div>
                    <div class="form-check form-switch mb-0">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="is_enable_post_refinement"
                        checked
                      />
                      <label
                        class="form-check-label small"
                        for="is_enable_post_refinement"
                        >F: ポスト結果 (is_enable_post_refinement)</label
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Row: D (ログ詳細度) -->
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label small fw-bold"
                  >D: ログ詳細度 (log_level_type)</label
                >
                <div class="d-flex gap-3 mt-1">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="log_level_type"
                      id="log_normal"
                      value="normal"
                      checked
                    />
                    <label class="form-check-label" for="log_normal"
                      >Normal</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="log_level_type"
                      id="log_detail"
                      value="detail"
                    />
                    <label class="form-check-label" for="log_detail"
                      >Detail</label
                    >
                  </div>
                </div>
              </div>
            </div>

            <div
              class="mt-5 pt-3 border-top d-flex justify-content-end align-items-center"
            >
              <button
                type="button"
                id="execBtn"
                onclick="callApi()"
                class="btn btn-primary btn-lg px-5 shadow"
              >
                <i class="bi bi-lightning-charge-fill me-2"></i>実行する
              </button>
            </div>
          </form>
        </div>
      </div>

      <div id="result-area" class="mt-4" style="display: none">
        <div class="card shadow-sm">
          <div class="card-header bg-light">
            <h5 class="mb-0">実行結果</h5>
          </div>
          <div class="card-body">
            <div id="status-msg" class="mb-2 fw-bold"></div>
            <pre
              id="json-output"
              class="bg-dark text-light p-3 border rounded"
              style="max-height: 600px; overflow-y: auto; font-size: 0.85rem"
            ></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Prompt Modal -->
  <div
    class="modal fade"
    id="promptModal"
    tabindex="-1"
    aria-labelledby="promptModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="promptModalLabel">Prompt Content</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <pre
            id="promptModalContent"
            style="white-space: pre-wrap; word-wrap: break-word"
          ></pre>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal Container for HTMX -->
  <div id="modal-container"></div>
</div>
{% endblock %} {% block scripts %}
<script>
  // EがOFFならFを強制OFFにするロジック
  function syncPostRefinementFlag() {
    const e = document.getElementById("is_enable_batch_log");
    const f = document.getElementById("is_enable_post_refinement");
    if (!e.checked) {
      f.checked = false;
      f.disabled = true;
    } else {
      f.disabled = false;
    }
  }
  // CがONならD,E,Fを無効化するロジック
  function handleDryRunMode(val) {
    const isC = val === "mode_script";

    // E, F: DB設定 (Checkbox)
    const targets = ["is_enable_batch_log", "is_enable_post_refinement"];
    targets.forEach((id) => {
      const el = document.getElementById(id);
      if (isC) {
        el.checked = false;
        el.disabled = true;
      } else {
        el.disabled = false;
        if (id === "is_enable_batch_log") syncPostRefinementFlag();
      }
    });
  }
  async function callApi() {
    const btn = document.getElementById("execBtn");
    const resultArea = document.getElementById("result-area");
    const statusMsg = document.getElementById("status-msg");
    const jsonOutput = document.getElementById("json-output");

    btn.disabled = true;
    btn.innerHTML =
      '<span class="spinner-border spinner-border-sm me-2" role="status"></span>実行中...';
    resultArea.style.display = "block";
    statusMsg.className = "mb-2 fw-bold";
    statusMsg.textContent = "通信中...";
    jsonOutput.textContent = "";
    const payload = {
      user_id: document.getElementById("userId").value,
      date_start: document.getElementById("startDate").value,
      date_end: document.getElementById("endDate").value,
      target_post_ids: (function () {
        const raw = document.getElementById("postIds").value;
        if (!raw || raw.trim() === "") return [];
        return raw
          .split(",")
          .map((s) => Number(s.trim()))
          .filter((n) => !isNaN(n));
      })(),
      is_force_reprocess:
        document.getElementById("is_force_reprocess").value === "true",
      is_dry_run_only:
        document.querySelector('input[name="is_dry_run_only"]:checked')
          .value === "true",
      log_level_type: document.querySelector(
        'input[name="log_level_type"]:checked',
      ).value,
      is_enable_batch_log: document.getElementById("is_enable_batch_log")
        .checked,
      is_enable_post_refinement: document.getElementById(
        "is_enable_post_refinement",
      ).checked,
      action_mode: document.querySelector(
        'input[name="is_dry_run_only"]:checked',
      ).value,
    };

    try {
      const response = await fetch("/api/cleaning-post", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await response.json();
      if (response.ok) {
        statusMsg.textContent = "成功 (200 OK)";
        statusMsg.classList.add("text-success");
      } else {
        statusMsg.textContent = `エラー (${response.status}): ${data.detail || "不明なエラー"}`;
        statusMsg.classList.add("text-danger");
      }
      // jsonOutput.textContent = JSON.stringify(data, null, 2);
      const jsonString = JSON.stringify(data, null, 2);
      const highlightedJson = jsonString.replace(
        /"prompt": "((?:\\.|[^"\\])*)"/g,
        (match, promptContent) => {
          const decodedContent = JSON.parse(`"${promptContent}"`);
          // data-prompt-content='...' の中に入れるので、シングルクォートをエスケープする
          const attributeValue = JSON.stringify(decodedContent).replace(
            /'/g,
            "&#39;",
          );
          return `"prompt": "<a href='#' data-prompt-content='${attributeValue}' onclick='showPromptModal(this.dataset.promptContent); return false;'>(Click to view)</a>"`;
        },
      );
      jsonOutput.innerHTML = highlightedJson;
    } catch (error) {
      statusMsg.textContent = `通信エラー: ${error.message}`;
      statusMsg.classList.add("text-danger");
    } finally {
      btn.disabled = false;
      btn.innerHTML =
        '<i class="bi bi-lightning-charge-fill me-2"></i>実行する';
    }
  }

  function showPromptModal(jsonStringContent) {
    try {
      const content = JSON.parse(jsonStringContent);
      document.getElementById("promptModalContent").textContent = content;
      const modal = new bootstrap.Modal(document.getElementById("promptModal"));
      modal.show();
    } catch (e) {
      console.error("Failed to parse prompt content:", e, jsonStringContent);
      alert("プロンプト内容の表示に失敗しました。");
    }
  }

  // HTMX: コンテンツロード後にモーダルを表示
  document.body.addEventListener("htmx:afterSwap", function (evt) {
    if (evt.detail.target.id === "modal-container") {
      const modalEl = document.getElementById("postSelectionModal");
      if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      }
    }
  });

  // モーダルからの選択処理
  function selectPostId(ids) {
    const textarea = document.getElementById("postIds");
    // 既存のIDを配列として取得（空文字を除去）
    let currentIds = textarea.value
      .split(",")
      .map((s) => s.trim())
      .filter((s) => s);

    // 引数が配列でない場合は配列に変換
    const newIds = Array.isArray(ids) ? ids : [ids];

    // 重複をチェックして追加
    newIds.forEach((id) => {
      const idStr = String(id);
      if (!currentIds.includes(idStr)) currentIds.push(idStr);
    });

    textarea.value = currentIds.join(", ");
    // モーダルを閉じる
    const modalEl = document.getElementById("postSelectionModal");
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
  }
</script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}
