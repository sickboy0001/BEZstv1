{% extends "base.html" %} {% block title %}Dashboard - API Test{% endblock %} {%
block content %}
<div class="container mt-4">
  <div class="d-flex align-items-center mb-4 border-bottom pb-3">
    <h2 class="mb-0">システム実行トレースログ & APIテスト</h2>
  </div>

  <div class="row">
    <div class="col-lg-3">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary text-white fw-bold small">
          <i class="bi bi-info-circle me-1"></i> 処理工程（Step）の定義
        </div>
        <ul class="list-group list-group-flush small">
          <li
            class="list-group-item d-flex justify-content-between align-items-start"
          >
            <div class="ms-2 me-auto">
              <div class="fw-bold">1-4: 対象抽出</div>
              <span class="text-muted small">DBからポストを抽出</span>
            </div>
            <span class="badge bg-info rounded-pill small">targets</span>
          </li>
          <li
            class="list-group-item d-flex justify-content-between align-items-start"
          >
            <div class="ms-2 me-auto">
              <div class="fw-bold">5-7: AI精査</div>
              <span class="text-muted small">プロンプト・回答取得</span>
            </div>
            <span class="badge bg-info rounded-pill small">airesult</span>
          </li>
          <li
            class="list-group-item d-flex justify-content-between align-items-start"
          >
            <div class="ms-2 me-auto">
              <div class="fw-bold">8-9: 最終検証</div>
              <span class="text-muted small">反映直前データ作成</span>
            </div>
            <span class="badge bg-info rounded-pill small">results</span>
          </li>
          <li
            class="list-group-item d-flex justify-content-between align-items-start bg-light"
          >
            <div class="ms-2 me-auto">
              <div class="fw-bold">10: 完了</div>
              <span class="text-muted small">DB更新完了</span>
            </div>
            <span class="badge bg-success rounded-pill small">none</span>
          </li>
        </ul>
      </div>
    </div>

    <div class="col-lg-9">
      {% if error %}
      <div class="alert alert-danger mb-4">{{ error }}</div>
      {% endif %}

      <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white p-3">
          <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>実行パラメータ</h5>
        </div>
        <div class="card-body bg-light-subtle">
          <form
            onsubmit="
              event.preventDefault();
              callApi();
            "
          >
            <div class="mb-4">
              <label class="form-label fw-bold"
                >User ID <span class="badge bg-danger ms-1">必須</span></label
              >
              <input
                type="text"
                id="userId"
                class="form-control"
                placeholder="UUIDを入力"
                value="{{ user_id }}"
                required
              />
            </div>

            <div class="card border-primary-subtle mb-4">
              <div class="card-body bg-white">
                <div class="mb-4">
                  <h6 class="fw-bold text-secondary">
                    <i class="bi bi-calendar-range me-1"></i>期間指定
                  </h6>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label small text-muted">開始日</label>
                      <input
                        type="date"
                        id="startDate"
                        class="form-control"
                        value="{{ target_period.start_date }}"
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small text-muted">終了日</label>
                      <input
                        type="date"
                        id="endDate"
                        class="form-control"
                        value="{{ target_period.end_date }}"
                      />
                    </div>
                  </div>
                </div>

                <hr class="text-secondary opacity-25" />

                <div>
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <h6 class="fw-bold text-secondary mb-0">
                      <i class="bi bi-list-check me-1"></i>ID指定
                    </h6>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-primary"
                      hx-get="/api/ui/post-selector"
                      hx-target="#modal-container"
                      hx-swap="innerHTML"
                    >
                      <i class="bi bi-search"></i> 選択
                    </button>
                  </div>
                  <div class="mt-2">
                    <label class="form-label small text-muted"
                      >特定Post ID指定（カンマ区切り）</label
                    >
                    <textarea
                      id="postIds"
                      class="form-control"
                      rows="2"
                      placeholder="例: 101, 102"
                    ></textarea>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label small fw-bold">精査対象の状態</label>
                <select id="targetCondition" class="form-select">
                  {% for option in target_condition_options %} {% set
                  is_selected = 'selected' if option.value ==
                  default_target_condition else '' %}
                  <option value="{{ option.value }}" {{ is_selected }}>
                    {{ option.label }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label small fw-bold">ログ詳細度</label>
                <select id="loglevel" class="form-select">
                  {% for option in loglevel_options %} {% set is_selected =
                  'selected' if option.value == default_loglevel else '' %}
                  <option value="{{ option.value }}" {{ is_selected }}>
                    {{ option.label }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label small fw-bold text-info"
                  >停止ポイント</label
                >
                <select id="disp" class="form-select border-info fw-bold">
                  {% for option in disp_options %} {% set is_selected =
                  'selected' if option.value == default_disp else '' %}
                  <option value="{{ option.value }}" {{ is_selected }}>
                    {{ option.label }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div
              class="mt-5 pt-3 border-top d-flex justify-content-end align-items-center"
            >
              <button
                type="button"
                id="execBtn"
                onclick="callApi()"
                class="btn btn-primary btn-lg px-5 shadow"
              >
                <i class="bi bi-lightning-charge-fill me-2"></i>実行する
              </button>
            </div>
          </form>
        </div>
      </div>

      <div id="result-area" class="mt-4" style="display: none">
        <div class="card shadow-sm">
          <div class="card-header bg-light">
            <h5 class="mb-0">実行結果</h5>
          </div>
          <div class="card-body">
            <div id="status-msg" class="mb-2 fw-bold"></div>
            <pre
              id="json-output"
              class="bg-dark text-light p-3 border rounded"
              style="max-height: 600px; overflow-y: auto; font-size: 0.85rem"
            ></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Container for HTMX -->
  <div id="modal-container"></div>
</div>
{% endblock %} {% block scripts %}
<script>
  async function callApi() {
    const btn = document.getElementById("execBtn");
    const resultArea = document.getElementById("result-area");
    const statusMsg = document.getElementById("status-msg");
    const jsonOutput = document.getElementById("json-output");

    btn.disabled = true;
    btn.innerHTML =
      '<span class="spinner-border spinner-border-sm me-2" role="status"></span>実行中...';
    resultArea.style.display = "block";
    statusMsg.className = "mb-2 fw-bold";
    statusMsg.textContent = "通信中...";
    jsonOutput.textContent = "";

    const payload = {
      user_id: document.getElementById("userId").value,
      target_period: {
        start_date: document.getElementById("startDate").value,
        end_date: document.getElementById("endDate").value,
      },
      post_ids: (function () {
        const raw = document.getElementById("postIds").value;
        if (!raw || raw.trim() === "") return null;
        return raw
          .split(",")
          .map((s) => Number(s.trim()))
          .filter((n) => !isNaN(n));
      })(),
      target_condition: document.getElementById("targetCondition").value,
      loglevel: document.getElementById("loglevel").value,
      disp: document.getElementById("disp").value,
    };

    try {
      const response = await fetch("/api/cleaning-post", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await response.json();
      if (response.ok) {
        statusMsg.textContent = "成功 (200 OK)";
        statusMsg.classList.add("text-success");
      } else {
        statusMsg.textContent = `エラー (${response.status}): ${data.detail || "不明なエラー"}`;
        statusMsg.classList.add("text-danger");
      }
      jsonOutput.textContent = JSON.stringify(data, null, 2);
    } catch (error) {
      statusMsg.textContent = `通信エラー: ${error.message}`;
      statusMsg.classList.add("text-danger");
    } finally {
      btn.disabled = false;
      btn.innerHTML =
        '<i class="bi bi-lightning-charge-fill me-2"></i>実行する';
    }
  }

  // HTMX: コンテンツロード後にモーダルを表示
  document.body.addEventListener("htmx:afterSwap", function (evt) {
    if (evt.detail.target.id === "modal-container") {
      const modalEl = document.getElementById("postSelectionModal");
      if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      }
    }
  });

  // モーダルからの選択処理
  function selectPostId(ids) {
    const textarea = document.getElementById("postIds");
    // 既存のIDを配列として取得（空文字を除去）
    let currentIds = textarea.value
      .split(",")
      .map((s) => s.trim())
      .filter((s) => s);

    // 引数が配列でない場合は配列に変換
    const newIds = Array.isArray(ids) ? ids : [ids];

    // 重複をチェックして追加
    newIds.forEach((id) => {
      const idStr = String(id);
      if (!currentIds.includes(idStr)) currentIds.push(idStr);
    });

    textarea.value = currentIds.join(", ");
    // モーダルを閉じる
    const modalEl = document.getElementById("postSelectionModal");
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
  }
</script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}
